(async function init() {
  // Cargar clientes desde el propio servidor (sirviendo el JSON estÃ¡tico o desde un endpoint)
  const customers = await fetch("/data/customers.json").then(r => r.json());
  const sel = document.getElementById("customerSelect");
  const link = document.getElementById("waDeepLink");
  const btn = document.getElementById("startBtn");

  customers.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.phone;
    opt.textContent = `${c.name} (${c.phone})`;
    sel.appendChild(opt);
  });

  function buildWaLink(phone, text) {
    const encoded = encodeURIComponent(text || "Hola, quiero hacer un pedido.");
    return `https://wa.me/${phone}?text=${encoded}`;
  }

  function updateDeepLink() {
    const phone = sel.value;
    link.href = buildWaLink(phone);
    link.textContent = "Abrir chat (deep link)";
  }

  updateDeepLink();
  sel.addEventListener("change", updateDeepLink);

  btn.addEventListener("click", async () => {
    const phone = sel.value;
    btn.disabled = true;
    try {
      const res = await fetch(`/api/send-start?phone=${encodeURIComponent(phone)}`, { method: "POST" });
      const data = await res.json();
      alert(data.ok ? "Inicio enviado por WhatsApp" : "No se pudo enviar");
    } catch (e) {
      alert("Error enviando el inicio");
    } finally {
      btn.disabled = false;
    }
  });
})();
